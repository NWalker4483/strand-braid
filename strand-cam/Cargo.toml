[package]
name = "strand-cam"
version =  "0.12.0-alpha.3" # braid release synchronized
authors = ["Andrew Straw <strawman@astraw.com>"]
build = "build.rs"
homepage = "https://strawlab.org/strand-cam"
edition = "2021"
rust-version = "1.60"

[lib]
path = "src/strand-cam.rs"

[dependencies]
jemallocator = {version="0.3", optional=true}
async-change-tracker = "0.3"
bui-backend-types = "0.8"
bui-backend = {version="0.15", default-features = false}
qrcodegen = "1.4"
log = { version = "0.4.5", features = ["release_max_level_debug"] }
ctrlc = { version = "3.1.3", features = ["termination"] }
stream-cancel = "0.8"
csv = {version="1.1", optional=true}
libflate = {version="1.0", optional=true}
env-tracing-logger = {path="../env-tracing-logger"}

includedir = { version = "0.6", optional = true }
phf = { version = "0.8", optional = true }
serde = {version="1.0.79",features=["derive"]}
serde_json = "1.0.29"
serde_yaml = "0.9"
serde_cbor = "0.11"
webbrowser = "0.8.3"
tempfile = "3.4.0"
clap = { version = "4", features = [ "string" ] }
preferences = {version="2.0.0", package = "preferences-serde1"}
directories = "4.0.1"
anyhow = "1.0"
thiserror = "1.0.33"
parking_lot = "0.12"
thread-control = {version="0.1.2", optional=true}
ipp-sys = {version="0.4.4", optional=true}
ci2 = { path = "../ci2" }
ci2-async = { path = "../ci2-async" }
ci2-types = { path = "../ci2/ci2-types" }
ci2-remote-control = { path = "../ci2-remote-control" }
machine-vision-formats = "0.1"
timestamped-frame = { path = "../timestamped-frame" }
basic-frame = { path = "../basic-frame", features = ["convert-image"] }
fmf = {path = "../fmf"}
ufmf = {path = "../ufmf"}
chrono = {version="0.4.27", default-features=false, features=["serde", "clock", "std", "wasmbind"]}
convert-image = {path = "../convert-image"}
hyper = {version="1.1", features=["client","http1"]}
hyper-tls = "0.6"
futures = "0.3"
tokio = {version="1.0.1", default-features=false, features=["rt","rt-multi-thread","time","sync"]}
tokio-util = {version = "0.7.3", features=["codec"]}
tokio-stream = {version = "0.1.6", features=["time"]}
dotenv = "0.15.0"
strand-cam-storetype = {path = "../strand-cam-storetype"}
flydra-feature-detector = {path = "../flydra-feature-detector", default-features = false, optional=true}
flydra-feature-detector-types = {path = "../flydra-feature-detector/flydra-feature-detector-types", default-features = false}
flydra-pt-detect-cfg = {path = "../flydra-feature-detector/flydra-pt-detect-cfg"}
datetime-conversion = {path = "../datetime-conversion"}
http-video-streaming-types = {path = "../http-video-streaming/http-video-streaming-types"}
http-video-streaming = {path = "../http-video-streaming"}
semver = { version = "1", features = ["serde"] }
shellexpand = "2"
imops = {path="../imops"}
led-box = {path="../led-box"}
led-box-comms = {path="../led-box-comms"}
flydra-types = {path="../flydra-types", features=["with-dns"]}
flydra2 = {path="../flydra2", default-features = false, optional=true}
mvg = {path="../mvg", optional=true}
flydra-mvg = {path="../flydra-mvg", optional=true}
tokio-serial = { version = "5.4.3"}
bytes = "1.0"
nalgebra = {version="0.32", optional = true }
opencv-ros-camera = "0.14"
alga = { version = "0.9", optional = true }
approx = { version = "0.5", optional = true }
byteorder = "1.4"
target = "2.0.0"
hyper-util = { version = "0.1.1", features = ["full"] }
http-body-util = "0.1.0"

braid-config-data = {path="../braid-config-data"}
opencv-calibrate = {path="../opencv-calibrate", optional=true}
camcal = {path="../camcal", optional=true}
posix-scheduler = { path = "../posix-scheduler", optional=true}
rust-cam-bui-types = {path="../rust-cam-bui-types"}
mp4-writer = { path = "../media-utils/mp4-writer", features = [ "openh264" ] }
strand-cam-csv-config-types = {path="../strand-cam-csv-config-types"}
plugin-defs = {path="../plugin-defs", optional=true}
bg-movie-writer = {path="../bg-movie-writer"}
strand-cam-pseudo-cal = {path="../strand-cam-pseudo-cal", optional=true}
nvenc = {path="../nvenc"}
ads-apriltag = {path="../apriltag", optional=true}
channellib = {path="../channellib", optional=true}
braid-http-session = {path="../braid-http-session"}
bui-backend-session = { path = "../bui-backend-session" }

[build-dependencies]
build-util = {path="../build-util"}

[features]
default = ["flydra_feat_detect", "imtrack-absdiff", "do_not_use_ipp"]

fiducial = ["ads-apriltag", "csv", "libflate"]

backtrace = ["ci2/backtrace", "mp4-writer/backtrace", "bg-movie-writer/backtrace",
    "convert-image/backtrace", "http-video-streaming/backtrace",
    "flydra-feature-detector?/backtrace", "mvg?/backtrace", "flydra-mvg?/backtrace", "flydra2?/backtrace"]

checkercal = ["opencv-calibrate", "camcal", "mvg"]

plugin-process-frame = ["plugin-defs", "thread-control", "channellib"]
flydra-uds = ["flydra-feature-detector?/flydra-uds"]

# Priority setting, high priority for camera threads, low priority for bg-image thread
posix_sched_fifo = ["posix-scheduler", "posix-scheduler/linux"]

# Serve style
bundle_files = ["bui-backend/bundle_files", "build-util/bundle_files", "includedir", "phf", "flydra2?/bundle_files" ]
serve_files = ["bui-backend/serve_files", "build-util/serve_files", "flydra2?/serve_files"]

imtrack-dark-circle = []
imtrack-absdiff = []

flydratrax = ["mvg", "nalgebra", "strand-cam-pseudo-cal", "flydra-mvg",
    "approx", "alga", "flydra2", "flydra_feat_detect"]

# build with the flydra-feature-detector
flydra_feat_detect = ["flydra-feature-detector"]

use_ipp = ["flydra-feature-detector?/use_ipp"]
do_not_use_ipp = ["flydra-feature-detector?/do_not_use_ipp"]

# TODO:
# fix so this is not needed in linux: `export LD_LIBRARY_PATH=/opt/Vimba_6_0/Tools/Viewer/Bin/x86_64bit`
# Also this reduces warnings in linux: sudo adduser strawlab video
